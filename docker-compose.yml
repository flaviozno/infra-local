version: "3.9"

services:
  # =======================
  # üîê Keycloak
  # =======================
  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    container_name: keycloak
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_PROXY_HEADERS: "xforwarded"
      KC_HTTP_RELATIVE_PATH: "/auth"
      JAVA_OPTS_APPEND: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
    ports:
      - "8080:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    restart: always
    networks:
      - dev-net
    volumes:
      - ./data/keycloak/providers:/opt/keycloak/providers
      - ./data/keycloak/themes:/opt/keycloak/themes
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/auth/ || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 40s

  # =======================
  # üêò PostgreSQL (Keycloak)
  # =======================
  keycloak-db:
    image: postgres:16
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - ./data/keycloak-db:/var/lib/postgresql/data
    restart: always
    networks:
      - dev-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # =======================
  # üß© SQL Server
  # =======================
  mssql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: mssql-dev
    user: root
    restart: always
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "S0DV2IEaf"
      MSSQL_PID: "Developer"
      MSSQL_COLLATION: "SQL_Latin1_General_CP1_CI_AS"
    ports:
      - "1433:1433"
    volumes:
      - ./data/mssql:/var/opt/mssql
    networks:
      - dev-net
    healthcheck:
      test:
        [
          "CMD",
          "/opt/mssql-tools/bin/sqlcmd",
          "-S",
          "localhost",
          "-U",
          "sa",
          "-P",
          "S0DV2IEaf",
          "-Q",
          "SELECT 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 12
      start_period: 40s

  # =======================
  # üêò PostgreSQL (Padr√£o)
  # =======================
  pg-dev:
    image: postgres:16
    container_name: pg-dev
    environment:
      POSTGRES_USER: flaviozno
      POSTGRES_PASSWORD: f@123
    volumes:
      - ./data/pg-dev:/var/lib/postgresql/data
    restart: always
    ports:
      - "5432:5432"
    networks:
      - dev-net

  # =======================
  # üê¨ MySQL
  # =======================
  mysql-dev:
    image: mysql:8.0
    container_name: mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: f@123
      MYSQL_USER: flaviozno
      MYSQL_PASSWORD: f@123
      MYSQL_DATABASE: default
    volumes:
      - ./data/mysql-dev:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: always
    networks:
      - dev-net

  nginx:
    image: nginx:latest
    container_name: nginx-reverse-proxy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    ports:
      - "443:443"
    depends_on:
      - keycloak
    networks:
      - dev-net

  # =======================
  # üçÉ MongoDB
  # =======================
  mongo-dev:
    image: mongo:6
    container_name: mongo-dev
    environment:
      MONGO_INITDB_ROOT_USERNAME: flaviozno
      MONGO_INITDB_ROOT_PASSWORD: f@123
    ports:
      - "27017:27017"
    volumes:
      - ./data/mongo-dev:/data/db
    restart: always
    networks:
      - dev-net

  # =======================
  # üîÅ Redis
  # =======================
  redis-dev:
    image: redis:7
    container_name: redis-dev
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis-dev:/data
    command: ["redis-server", "--appendonly", "yes"]
    restart: always
    networks:
      - dev-net

    # =======================
  # üìä SonarQube
  # =======================
  sonarqube:
    image: sonarqube:latest
    container_name: sonarqube
    depends_on:
      sonar-db:
        condition: service_healthy
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://sonar-db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    ports:
      - "9000:9000"
    volumes:
      - ./data/sonarqube/data:/opt/sonarqube/data
      - ./data/sonarqube/extensions:/opt/sonarqube/extensions
      - ./data/sonarqube/logs:/opt/sonarqube/logs
    restart: always
    networks:
      - dev-net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:9000/api/system/health || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 40s

  # =======================
  # üêò PostgreSQL (SonarQube)
  # =======================
  sonar-db:
    image: postgres:16
    container_name: sonar-db
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonar
    volumes:
      - ./data/sonar-db:/var/lib/postgresql/data
    restart: always
    networks:
      - dev-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

# =======================
# Volumes
# =======================
volumes:
  keycloak_data:
  mssql_data:
  pg_data:
  mysql_data:
  mongo_data:
  redis_data:

# =======================
# Rede
# =======================
networks:
  dev-net:
    driver: bridge
